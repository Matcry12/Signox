{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Flashcard" %} - {{ lesson.title }} - Signox{% endblock %}

{% block extra_css %}
<style>
    .flashcard-container {
        max-width: 600px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .flashcard-header {
        text-align: center;
        margin-bottom: 1.5rem;
    }

    .flashcard-header h1 {
        font-size: 1.5rem;
        margin-bottom: 0.25rem;
    }

    /* Mastery Stats */
    .mastery-stats {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
    }

    .mastery-stat {
        text-align: center;
    }

    .mastery-stat .value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .mastery-stat .label {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .mastery-bar {
        height: 6px;
        background: var(--bg-tertiary);
        border-radius: 9999px;
        overflow: hidden;
        margin-top: 0.5rem;
    }

    .mastery-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #10B981, #34D399);
        border-radius: 9999px;
        transition: width 0.5s ease;
    }

    /* Progress Dots */
    .flashcard-progress {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .progress-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--bg-tertiary);
        transition: all 0.3s;
    }

    .progress-dot.active {
        background: var(--primary-color);
        transform: scale(1.2);
    }

    .progress-dot.mastered {
        background: #10B981;
    }

    .progress-dot.learning {
        background: #F59E0B;
    }

    .progress-dot.due {
        background: #EF4444;
    }

    /* Flashcard */
    .flashcard {
        perspective: 1000px;
        height: 320px;
        cursor: pointer;
        margin-bottom: 1.5rem;
    }

    .flashcard-inner {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
        transition: transform 0.6s;
        transform-style: preserve-3d;
    }

    .flashcard.flipped .flashcard-inner {
        transform: rotateY(180deg);
    }

    .flashcard-front, .flashcard-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border-radius: var(--radius-xl);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        box-shadow: var(--shadow-lg);
    }

    .flashcard-front {
        background: linear-gradient(135deg, var(--primary-color) 0%, #7C3AED 100%);
        color: white;
    }

    .flashcard-back {
        background: var(--card-bg);
        transform: rotateY(180deg);
    }

    .flashcard-word {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
    }

    .flashcard-hint {
        opacity: 0.8;
        font-size: 0.875rem;
    }

    .flashcard-meaning {
        font-size: 1.5rem;
        color: var(--text-primary);
        margin-bottom: 0.75rem;
    }

    .flashcard-description {
        color: var(--text-secondary);
        font-size: 0.9375rem;
        margin-bottom: 1rem;
    }

    .card-mastery-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: rgba(255,255,255,0.2);
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    /* Rating Buttons - Anki Style */
    .rating-section {
        display: none;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    .rating-section.visible {
        display: flex;
    }

    .rating-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .rating-buttons {
        display: flex;
        gap: 0.75rem;
        justify-content: center;
    }

    .rating-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        padding: 0.75rem 1.25rem;
        border-radius: var(--radius-lg);
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 70px;
    }

    .rating-btn:hover {
        transform: translateY(-2px);
    }

    .rating-btn .interval {
        font-size: 0.6875rem;
        opacity: 0.8;
    }

    .rating-btn .label {
        font-size: 0.8125rem;
        font-weight: 600;
    }

    .rating-btn.again {
        background: #FEE2E2;
        color: #DC2626;
        border-color: #FECACA;
    }

    .rating-btn.again:hover {
        background: #FECACA;
    }

    .rating-btn.hard {
        background: #FEF3C7;
        color: #D97706;
        border-color: #FDE68A;
    }

    .rating-btn.hard:hover {
        background: #FDE68A;
    }

    .rating-btn.good {
        background: #D1FAE5;
        color: #059669;
        border-color: #A7F3D0;
    }

    .rating-btn.good:hover {
        background: #A7F3D0;
    }

    .rating-btn.easy {
        background: #DBEAFE;
        color: #2563EB;
        border-color: #BFDBFE;
    }

    .rating-btn.easy:hover {
        background: #BFDBFE;
    }

    /* Navigation Controls */
    .nav-controls {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1rem;
    }

    .nav-controls.hidden {
        display: none;
    }

    .control-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: transform 0.2s;
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .control-btn:hover {
        transform: scale(1.1);
    }

    .control-btn.flip {
        background: var(--primary-color);
        color: white;
        width: 60px;
        height: 60px;
    }

    .counter {
        text-align: center;
        color: var(--text-secondary);
        margin-top: 1rem;
        font-size: 0.875rem;
    }

    /* Feedback Toast */
    .rating-feedback {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--gray-900);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius-lg);
        font-size: 0.875rem;
        opacity: 0;
        transition: all 0.3s;
        z-index: 1000;
    }

    .rating-feedback.visible {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }

    /* Complete Screen */
    .complete-screen {
        display: none;
        text-align: center;
        padding: 3rem 2rem;
    }

    .complete-screen.visible {
        display: block;
    }

    .complete-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #10B981, #34D399);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        color: white;
    }

    .complete-screen h2 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .complete-stats {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin: 1.5rem 0;
    }

    /* Dark Mode */
    [data-theme="dark"] .mastery-stats {
        background: #334155;
    }

    [data-theme="dark"] .flashcard-back {
        background: #1E293B;
    }

    [data-theme="dark"] .flashcard-meaning {
        color: #F1F5F9;
    }

    [data-theme="dark"] .flashcard-description {
        color: #94A3B8;
    }

    [data-theme="dark"] .rating-btn.again {
        background: rgba(220, 38, 38, 0.2);
        border-color: rgba(220, 38, 38, 0.3);
    }

    [data-theme="dark"] .rating-btn.hard {
        background: rgba(217, 119, 6, 0.2);
        border-color: rgba(217, 119, 6, 0.3);
    }

    [data-theme="dark"] .rating-btn.good {
        background: rgba(5, 150, 105, 0.2);
        border-color: rgba(5, 150, 105, 0.3);
    }

    [data-theme="dark"] .rating-btn.easy {
        background: rgba(37, 99, 235, 0.2);
        border-color: rgba(37, 99, 235, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="flashcard-container">
    <div class="flashcard-header">
        <a href="{% url 'lesson_detail' lesson.slug %}" class="btn btn-secondary mb-2">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            {% trans "Back to Lesson" %}
        </a>
        <h1>{{ lesson.title }}</h1>
        <p style="color: var(--text-secondary);">{% trans "Spaced Repetition Flashcards" %}</p>
    </div>

    <!-- Mastery Stats -->
    <div class="mastery-stats">
        <div class="mastery-stat">
            <div class="value">{{ avg_mastery }}%</div>
            <div class="label">{% trans "Mastery" %}</div>
            <div class="mastery-bar" style="width: 80px;">
                <div class="mastery-bar-fill" style="width: {{ avg_mastery }}%;"></div>
            </div>
        </div>
        <div class="mastery-stat">
            <div class="value">{{ due_cards }}</div>
            <div class="label">{% trans "Due Today" %}</div>
        </div>
        <div class="mastery-stat">
            <div class="value">{{ total_cards }}</div>
            <div class="label">{% trans "Total Cards" %}</div>
        </div>
    </div>

    <div class="flashcard-progress" id="progressDots"></div>

    <!-- Main Flashcard Area -->
    <div id="flashcardArea">
        <div class="flashcard" id="flashcard" onclick="flipCard()">
            <div class="flashcard-inner">
                <div class="flashcard-front">
                    <div class="card-mastery-badge" id="cardMastery">0%</div>
                    <div class="flashcard-word" id="frontWord"></div>
                    <div class="flashcard-hint">{% trans "Tap to reveal meaning" %}</div>
                </div>
                <div class="flashcard-back">
                    <div class="flashcard-meaning" id="backMeaning"></div>
                    <div class="flashcard-description" id="backDescription"></div>
                </div>
            </div>
        </div>

        <!-- Rating Buttons (shown after flip) -->
        <div class="rating-section" id="ratingSection">
            <div class="rating-label">{% trans "How well did you know this?" %}</div>
            <div class="rating-buttons">
                <button class="rating-btn again" onclick="rateCard(1)">
                    <span class="interval">&lt;1 min</span>
                    <span class="label">{% trans "Again" %}</span>
                </button>
                <button class="rating-btn hard" onclick="rateCard(2)">
                    <span class="interval" id="hardInterval">1d</span>
                    <span class="label">{% trans "Hard" %}</span>
                </button>
                <button class="rating-btn good" onclick="rateCard(3)">
                    <span class="interval" id="goodInterval">1d</span>
                    <span class="label">{% trans "Good" %}</span>
                </button>
                <button class="rating-btn easy" onclick="rateCard(4)">
                    <span class="interval" id="easyInterval">4d</span>
                    <span class="label">{% trans "Easy" %}</span>
                </button>
            </div>
        </div>

        <!-- Navigation (shown before flip) -->
        <div class="nav-controls" id="navControls">
            <button class="control-btn prev" onclick="prevCard()">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M15 19l-7-7 7-7"/>
                </svg>
            </button>
            <button class="control-btn flip" onclick="flipCard()">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
            </button>
            <button class="control-btn next" onclick="nextCard()">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M9 5l7 7-7 7"/>
                </svg>
            </button>
        </div>

        <div class="counter">
            <span id="currentIndex">1</span> / <span id="totalCount">{{ total_cards }}</span>
        </div>
    </div>

    <!-- Complete Screen -->
    <div class="complete-screen" id="completeScreen">
        <div class="complete-icon">
            <svg width="40" height="40" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M5 13l4 4L19 7"/>
            </svg>
        </div>
        <h2>{% trans "Session Complete!" %}</h2>
        <p style="color: var(--text-secondary);">{% trans "Great job reviewing your flashcards." %}</p>
        <div class="complete-stats">
            <div class="mastery-stat">
                <div class="value" id="reviewedCount">0</div>
                <div class="label">{% trans "Cards Reviewed" %}</div>
            </div>
            <div class="mastery-stat">
                <div class="value" id="correctCount">0</div>
                <div class="label">{% trans "Good/Easy" %}</div>
            </div>
        </div>
        <div class="flex gap-1 justify-center mt-2">
            <button class="btn btn-primary" onclick="restartSession()">{% trans "Practice Again" %}</button>
            <a href="{% url 'lesson_detail' lesson.slug %}" class="btn btn-secondary">{% trans "Back to Lesson" %}</a>
        </div>
    </div>
</div>

<div class="rating-feedback" id="ratingFeedback"></div>

<script>
    const vocabularies = {{ vocabularies_json|safe }};
    let currentIndex = 0;
    let isFlipped = false;
    let reviewedCount = 0;
    let correctCount = 0;

    function initFlashcards() {
        if (vocabularies.length === 0) {
            document.getElementById('flashcardArea').innerHTML =
                '<div style="text-align: center; padding: 3rem; color: var(--text-secondary);">{% trans "No vocabulary items in this lesson." %}</div>';
            return;
        }

        // Create progress dots
        const dotsContainer = document.getElementById('progressDots');
        vocabularies.forEach((vocab, i) => {
            const dot = document.createElement('div');
            dot.className = 'progress-dot';
            dot.id = `dot-${i}`;

            // Color based on mastery
            const mastery = vocab.review.mastery;
            if (mastery >= 80) {
                dot.classList.add('mastered');
            } else if (mastery >= 30) {
                dot.classList.add('learning');
            } else if (vocab.review.is_due) {
                dot.classList.add('due');
            }

            if (i === 0) dot.classList.add('active');
            dotsContainer.appendChild(dot);
        });

        showCard(0);
    }

    function showCard(index) {
        const vocab = vocabularies[index];
        document.getElementById('frontWord').textContent = vocab.word;
        document.getElementById('backMeaning').textContent = vocab.meaning;
        document.getElementById('backDescription').textContent = vocab.description || '';
        document.getElementById('cardMastery').textContent = vocab.review.mastery + '%';
        document.getElementById('currentIndex').textContent = index + 1;

        // Calculate predicted intervals for display
        const review = vocab.review;
        const interval = review.interval || 0;
        const easeFactor = 2.5; // Default

        document.getElementById('hardInterval').textContent = formatInterval(Math.max(1, Math.floor(interval * 0.5)));
        document.getElementById('goodInterval').textContent = formatInterval(review.repetitions === 0 ? 1 : (review.repetitions === 1 ? 3 : Math.floor(interval * easeFactor)));
        document.getElementById('easyInterval').textContent = formatInterval(review.repetitions === 0 ? 4 : Math.floor(interval * easeFactor * 1.3));

        // Update progress dots
        document.querySelectorAll('.progress-dot').forEach((dot, i) => {
            dot.classList.remove('active');
            if (i === index) dot.classList.add('active');
        });

        // Reset flip state and UI
        if (isFlipped) {
            document.getElementById('flashcard').classList.remove('flipped');
            isFlipped = false;
        }
        document.getElementById('ratingSection').classList.remove('visible');
        document.getElementById('navControls').classList.remove('hidden');
    }

    function formatInterval(days) {
        if (days === 0) return '<1d';
        if (days === 1) return '1d';
        if (days < 30) return days + 'd';
        if (days < 365) return Math.floor(days / 30) + 'mo';
        return Math.floor(days / 365) + 'y';
    }

    function flipCard() {
        const card = document.getElementById('flashcard');
        card.classList.toggle('flipped');
        isFlipped = !isFlipped;

        // Show rating buttons when flipped
        if (isFlipped) {
            document.getElementById('ratingSection').classList.add('visible');
            document.getElementById('navControls').classList.add('hidden');
        } else {
            document.getElementById('ratingSection').classList.remove('visible');
            document.getElementById('navControls').classList.remove('hidden');
        }
    }

    function rateCard(rating) {
        const vocab = vocabularies[currentIndex];
        console.log('Rating card:', vocab.id, 'with rating:', rating);

        // Send rating to server
        fetch('{% url "flashcard_rate" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                vocabulary_id: vocab.id,
                rating: rating
            })
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                // Update local data
                vocab.review.mastery = data.mastery;
                vocab.review.interval = data.next_interval;

                // Update dot color
                const dot = document.getElementById(`dot-${currentIndex}`);
                dot.classList.remove('due', 'learning', 'mastered');
                if (data.mastery >= 80) {
                    dot.classList.add('mastered');
                } else if (data.mastery >= 30) {
                    dot.classList.add('learning');
                }

                // Show feedback
                showFeedback(data.message);

                // Track stats
                reviewedCount++;
                if (rating >= 3) correctCount++;

                // Move to next card or complete
                if (currentIndex < vocabularies.length - 1) {
                    currentIndex++;
                    setTimeout(() => showCard(currentIndex), 300);
                } else {
                    showComplete();
                }
            } else {
                showFeedback(data.error || 'Error saving rating');
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showFeedback('Error: ' + error.message);
        });
    }

    function showFeedback(message) {
        const feedback = document.getElementById('ratingFeedback');
        feedback.textContent = message;
        feedback.classList.add('visible');
        setTimeout(() => {
            feedback.classList.remove('visible');
        }, 2000);
    }

    function showComplete() {
        document.getElementById('flashcardArea').style.display = 'none';
        document.getElementById('completeScreen').classList.add('visible');
        document.getElementById('reviewedCount').textContent = reviewedCount;
        document.getElementById('correctCount').textContent = correctCount;
    }

    function restartSession() {
        currentIndex = 0;
        reviewedCount = 0;
        correctCount = 0;
        document.getElementById('flashcardArea').style.display = 'block';
        document.getElementById('completeScreen').classList.remove('visible');
        showCard(0);
    }

    function nextCard() {
        if (currentIndex < vocabularies.length - 1) {
            currentIndex++;
            showCard(currentIndex);
        }
    }

    function prevCard() {
        if (currentIndex > 0) {
            currentIndex--;
            showCard(currentIndex);
        }
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight' && !isFlipped) nextCard();
        if (e.key === 'ArrowLeft' && !isFlipped) prevCard();
        if (e.key === ' ') {
            e.preventDefault();
            flipCard();
        }
        // Number keys for rating (when flipped)
        if (isFlipped) {
            if (e.key === '1') rateCard(1);
            if (e.key === '2') rateCard(2);
            if (e.key === '3') rateCard(3);
            if (e.key === '4') rateCard(4);
        }
    });

    initFlashcards();
</script>
{% endblock %}
